<!DOCTYPE html>
<html>
	<head>
		<!-- insert Mapbox GL library links here -->

<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src ="https://cdn.jsdelivr.net/npm/luxon@1.25.0/build/global/luxon.min.js"/>
// <script src="luxon.js"></script>


		<style>
		#map {height: 80vh;}
		</style>
	</head>

	<body>
		<!-- create div for the map here -->
	<div id="map"></div>
<script>


// var endTime=new Date("Onscene")
// 			var startTime=new Date("CallRec");
// 			if (endTime < startTime) {
//     		endTime.setDate(endTime.getDate() + 1);
// }
// 			var diff = endTime - startTime;
// 			var time = diff;
// 			var mm = Math.floor(time / 1000 / 60);
// 			time -= mm * 1000 * 60;
// 			var ss = Math.floor(time / 1000);
// 		time -= ss * 1000;

			//copy your access token here
			 mapboxgl.accessToken = "pk.eyJ1IjoiaC13YXJyZW4iLCJhIjoiY2tnemJmaG54MDQzNjJ3cnN2Mmg1MmF2cyJ9.AMeyJ2g8BQiBQ2ZyH9OyJw"; //"yourAccessTokenHere";

		var map = new mapboxgl.Map({
			  container:"map", // HTML container id
			  style: "mapbox://styles/mapbox/streets-v11",  // style URL
			  center:[-122.4733, 47.255], // starting position as [lng, lat]
			  zoom: 10
				// starting zoom
		});

// Add GeoJSON layer
// on map load, run function to load the geojson
	function AddImages(map,image){
		const addImage = (map, id, url)=>{
				return new Promise((resolve, reject)=>{
					map.loadImage(url, (error, image)=> {
						if(error){
							reject(error);
							return;
						}
						map.addImage(id, image);
						resolve(image);
					});
				});
		}
		const promises = images.map( imageData=>addImage(map, imageData.id, imageData.url) );
		return Promise.all(promises);
}
	map.on("load",function(){
		addImages(map, [
			{"url":"https://github.com/mapbox/maki.git",
			"id":"fire-station-11"}
		]).then(()=>{
			map.addSource("FireTable",{
				"type":"geojson",
				"data":"TacFireShp.json",
				"cluster":true,
				"clusterMaxZoom":14,
				"clusterRadius":50

			});
		});
		// map.loadImage("fire-station-11",
		// 	function (error,image){
		// 		if (error) throw error;
		// 		map.addImage("fire-station-11",image);
		// 		map.addSource("https://github.com/mapbox/maki.git",{
		// 			"type":"geojson",
		// 			"data":"TacFireShp.json"
		// 		});
	//	});



		map.addLayer({
				"id": "clusters",
				"type": "symbol",
				"source": "FireTable",
				"layout":{
					"icon-image":"fire-station-11"
				},
				"icon-size":.4,
				"icon-allow-overlap":true,
			});
			map.addLayer({
				"id":"cluster-count-bg",
				"type":"circle",
				"source":"FireTable",
				"filter":["has","point_count"],
				"paint": {
					"circle-color":[
						"step",["get","point_count"],
						"#51bbd6",
						30,
						"#f1f075",
						90,
						"#f28cb1",
						120,
						"grey",

					],
					"circle-radius":[
						"step",
						["get","point_count"],
						20,
						30,
						30,
						90,
						40
					]
				}
		});
		map.addLayer({
				"id":"cluster-count",
				"type":"symbol",
				"source":"FireTable",
				"filter":["has","point_count"],
				"layout":{
						"text-field":"{point_count_abbreviated}",
						"text-font":["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
						"text-size":12
				}
		});
		map.addLayer({
				"id":"unclustered-point",
				"type":"symbol",
				"source":"FireTable",
				"filter":["!",["has","point_count"]],
				"layout": {
						"icon-image": ["get","point_count"],
						"icon-size":.4,
						"icon-allow-overlap":true
				},
			});
		 });

		map.on("click","clusters",function(e){
				var features = map.queryRenderedFeatures(e.point,
					{
						layers:["clusters"]

				});
				var clusterId= features[0].properties.cluster_id;
				map.getSource("FireTable").getClusterExpanssionZoom(
					clusterId,
					function(err, zoom){
						if (err)return;

						map.easeTo({
							"center":
								features[0].geometry.coordinates,
								"zoom":"zoom"
						});
					}
				);
		});





			map.on("click", "fireTime", function (e) {
			new mapboxgl.Popup()
			.setLngLat(e.lngLat)
			.setHTML("Date: <b>" +e.features[0].properties.RespTime + "</b>")
			.addTo(map);
			});

			map.on("mouseenter", "fireTime", function () {
map.getCanvas().style.cursor = "pointer";
});
//
// // Change it back to a pointer when it leaves.
				map.on("mouseleave", "fireTime", function () {
map.getCanvas().style.cursor = "pointer";
});

		</script>
		<p id="output"></p>
	</body>
</html>
